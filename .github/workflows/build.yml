name: Build FoxBridgeAgent Installer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'
    
    - name: Cache vcpkg packages
      uses: actions/cache@v3
      with:
        path: |
          ${{ github.workspace }}/vcpkg_installed
          ${{ env.VCPKG_ROOT }}/installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
    
    - name: Install vcpkg dependencies
      run: |
        vcpkg install boost-beast:x64-windows
        vcpkg install boost-system:x64-windows
        vcpkg install nlohmann-json:x64-windows
        vcpkg install spdlog:x64-windows
    
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Build executable
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
        .\build.ps1 -Configuration Release
      shell: pwsh
    
    - name: Install WiX Toolset
      run: |
        choco install wixtoolset -y
        echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
    
    - name: Install NSIS
      run: |
        choco install nsis -y
        echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
    
    - name: Build installers
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
        .\build.ps1 -SkipBuild -BuildInstaller
      shell: pwsh
    
    - name: List output files
      run: |
        Get-ChildItem -Path output -Recurse | Select-Object FullName, Length
      shell: pwsh
    
    - name: Upload executables
      uses: actions/upload-artifact@v3
      with:
        name: FoxBridgeAgent-Executable
        path: output/FoxBridgeAgent.exe
    
    - name: Upload MSI installer
      uses: actions/upload-artifact@v3
      with:
        name: FoxBridgeAgent-MSI-Installer
        path: output/FoxBridgeAgent-Setup.msi
    
    - name: Upload NSIS installer
      uses: actions/upload-artifact@v3
      with:
        name: FoxBridgeAgent-NSIS-Installer
        path: output/FoxBridgeAgent-Setup.exe
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          output/FoxBridgeAgent.exe
          output/FoxBridgeAgent-Setup.msi
          output/FoxBridgeAgent-Setup.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
